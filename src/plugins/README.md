# Plugins Directory

このディレクトリには、動的に読み込まれるプラグインが配置されます。

## プラグインの作成方法

### 1. ディレクトリ構造

```
src/plugins/
├── __init__.py
├── README.md
└── your_plugin_name/
    ├── __init__.py          # プラグインのエントリーポイント
    └── provider.py          # プロバイダーの実装（オプション）
```

### 2. プラグインの実装

#### LLMプロバイダーの例

**`src/plugins/custom_llm/__init__.py`**:

```python
"""Custom LLM Provider Plugin"""

from typing import Optional, Type
from pydantic import BaseModel
from src.core.providers.llm import LLMProvider
from src.core.plugin_loader import PluginMetadata


class CustomLLMProvider(LLMProvider):
    """カスタムLLMプロバイダー"""
    
    def __init__(self, api_key: str, model: str = "custom-model"):
        self.api_key = api_key
        self.model = model
    
    async def generate(
        self,
        prompt: str,
        temperature: float = 0.7,
        max_tokens: Optional[int] = None,
        **kwargs
    ) -> str:
        """テキスト生成"""
        # カスタム実装
        return f"Generated by {self.model}: {prompt}"
    
    async def generate_json(
        self,
        prompt: str,
        schema: Type[BaseModel],
        temperature: float = 0.7,
        **kwargs
    ) -> BaseModel:
        """JSON生成"""
        # カスタム実装
        pass
    
    async def generate_with_context(
        self,
        user_query: str,
        context: str,
        system_instruction: Optional[str] = None,
        temperature: float = 0.7,
        **kwargs
    ) -> str:
        """コンテキスト付き生成"""
        # カスタム実装
        pass


# プラグインメタデータ（必須）
plugin_metadata = PluginMetadata(
    name="custom_llm",
    version="1.0.0",
    author="Your Name",
    description="Custom LLM Provider for XYZ API",
    provider_type="llm",
    enabled=True,
    dependencies=["custom-api-client>=1.0.0"]
)
```

#### RAGプロバイダーの例

**`src/plugins/custom_rag/__init__.py`**:

```python
"""Custom RAG Provider Plugin"""

from typing import List, Dict, Any
from src.core.providers.rag import RAGProvider
from src.core.plugin_loader import PluginMetadata


class CustomRAGProvider(RAGProvider):
    """カスタムRAGプロバイダー"""
    
    async def query(
        self,
        query: str,
        collection_name: str = "default",
        top_k: int = 5,
        **kwargs
    ) -> Dict[str, Any]:
        """RAGクエリを実行"""
        # カスタム実装
        return {
            "answer": "Custom RAG answer",
            "sources": [],
            "confidence": 0.9
        }


# プラグインメタデータ（必須）
plugin_metadata = PluginMetadata(
    name="custom_rag",
    version="1.0.0",
    author="Your Name",
    description="Custom RAG Provider with advanced features",
    provider_type="rag",
    enabled=True,
    dependencies=[]
)
```

### 3. プラグインの使用

#### 自動読み込み（推奨）

アプリケーション起動時に自動的に読み込まれます：

```python
# main.py
from src.core.plugin_loader import auto_load_plugins

# プラグインを自動検出・登録
plugins = auto_load_plugins()
print(f"Loaded {len(plugins)} plugins")

# プロバイダーを使用
from src.core.factory import ProviderFactory

provider = ProviderFactory.create_llm_provider("custom_llm", {
    "api_key": "your-api-key"
})
```

#### 手動読み込み

特定のプラグインのみを読み込む：

```python
from src.core.plugin_loader import PluginLoader

loader = PluginLoader()
plugin = loader.load_plugin("custom_llm")

print(f"Loaded: {plugin.metadata.name} v{plugin.metadata.version}")
```

## プラグインのメタデータ

### 必須フィールド

- **name**: プラグインの一意な名前
- **version**: バージョン（セマンティックバージョニング推奨）
- **author**: 作者名
- **description**: プラグインの説明
- **provider_type**: プロバイダータイプ（`"llm"` または `"rag"`）

### オプションフィールド

- **enabled**: 有効/無効フラグ（デフォルト: `True`）
- **dependencies**: 依存パッケージのリスト（デフォルト: `[]`）

## プラグインのテスト

プラグインのテストを作成することを推奨します：

```python
# tests/plugins/test_custom_llm.py

import pytest
from src.plugins.custom_llm import CustomLLMProvider, plugin_metadata


class TestCustomLLMPlugin:
    def test_metadata(self):
        """メタデータの検証"""
        assert plugin_metadata.name == "custom_llm"
        assert plugin_metadata.provider_type == "llm"
        assert plugin_metadata.enabled is True
    
    async def test_provider_generation(self):
        """プロバイダーのテスト"""
        provider = CustomLLMProvider(api_key="test-key")
        result = await provider.generate("Hello")
        assert isinstance(result, str)
```

## プラグインの無効化

プラグインを一時的に無効化する場合：

```python
plugin_metadata = PluginMetadata(
    name="custom_llm",
    version="1.0.0",
    author="Your Name",
    description="Custom LLM Provider",
    provider_type="llm",
    enabled=False,  # 無効化
)
```

## ベストプラクティス

1. **バージョン管理**: セマンティックバージョニングを使用
2. **依存関係の明示**: `dependencies` フィールドで明確に記載
3. **エラーハンドリング**: 適切な例外処理を実装
4. **ドキュメント**: docstringを充実させる
5. **テスト**: 包括的なテストケースを作成
6. **ロギング**: 適切なログを出力

## トラブルシューティング

### プラグインが読み込まれない

1. `__init__.py` が存在するか確認
2. `plugin_metadata` が定義されているか確認
3. プロバイダークラスが正しい基底クラスを継承しているか確認
4. ログを確認: `logger.setLevel(logging.DEBUG)`

### 依存パッケージのエラー

```bash
pip install package-name
```

## サンプルプラグイン

- `example_llm/`: LLMプロバイダーのサンプル
- `example_rag/`: RAGプロバイダーのサンプル

---

詳細は `src/core/plugin_loader.py` を参照してください。

